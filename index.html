<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Adventure Trakker</title>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-config.js"></script>

  <style>
    :root{
      --text: rgba(245,245,245,0.92);
      --muted: rgba(180,180,180,0.92);
      --panel: rgba(255,255,255,0.10);
      --panel-2: rgba(255,255,255,0.07);
      --border: rgba(255,255,255,0.16);
      --shadow: 0 14px 30px rgba(0,0,0,0.30);
      --bg: #0b0b0b;
      --danger: rgba(255,120,120,0.92);
    }
    html, body{
      height: 100%;
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow: hidden;
    }

    /* Background map image (optional). If the image is missing, the gradient still looks fine. */
    .bg{
      position: fixed;
      inset: 0;
      background:
        radial-gradient(ellipse at top, rgba(255,255,255,0.05), rgba(0,0,0,0.0) 55%),
        url("assets/north-america-map.png");
      background-size: cover;
      background-position: center;
      opacity: 0.35;
      pointer-events: none;
      filter: saturate(0.95) contrast(1.02);
    }

    .header{
      position: absolute;
      left: 0;
      right: 0;
      top: 18px;
      text-align: center;
      pointer-events: none;
      z-index: 5;
    }
    .header h1{
      margin: 0;
      font-weight: 300;
      letter-spacing: 0.08em;
      color: rgba(190,190,190,0.92);
      font-size: clamp(28px, 3vw, 46px);
      text-shadow: 0 12px 26px rgba(0,0,0,0.40);
    }

    .wrap{
      position: relative;
      height: 100%;
      display: grid;
      grid-template-columns: 360px 1fr 360px;
      gap: 14px;
      padding: 18px 16px;
      box-sizing: border-box;
    }

    .panel{
      align-self: start;
      margin-top: 74px;
      border-radius: 18px;
      background: var(--panel);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      overflow: hidden;
      backdrop-filter: blur(6px);
    }
    .panel .panel-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.06);
    }
    .panel .panel-title{
      margin: 0;
      font-weight: 300;
      letter-spacing: 0.05em;
      color: rgba(220,220,220,0.85);
      font-size: 14px;
      user-select: none;
    }
    .panel .panel-link{
      text-decoration: none;
      font-size: 12px;
      font-weight: 300;
      color: rgba(245,245,245,0.75);
      padding: 8px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
    }
    .panel .panel-body{
      padding: 12px 14px 14px;
      display:flex;
      flex-direction:column;
      gap: 10px;
      background: var(--panel-2);
      min-height: 120px;
    }

    .snippet{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      padding: 10px 12px;
    }
    .snippet .line1{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 6px;
    }
    .snippet .name{
      font-size: 13px;
      font-weight: 300;
      color: rgba(245,245,245,0.90);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      min-width: 0;
      flex: 1;
    }
    .snippet .date{
      font-size: 12px;
      font-weight: 300;
      color: rgba(245,245,245,0.65);
      white-space: nowrap;
    }
    .snippet .note{
      font-size: 12px;
      font-weight: 300;
      color: rgba(245,245,245,0.70);
      line-height: 1.35;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .center{
      position: relative;
      margin-top: 74px;
    }

    .float{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      display:flex;
      gap: 12px;
      z-index: 10;
    }
    .btn{
      border: none;
      border-radius: 16px;
      padding: 12px 16px;
      cursor: pointer;
      color: rgba(245,245,245,0.92);
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(255,255,255,0.16);
      box-shadow: var(--shadow);
      font-weight: 300;
      letter-spacing: 0.02em;
      text-decoration:none;
      user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,0.15); }

    .soft{
      font-size: 12px;
      font-weight: 300;
      color: rgba(245,245,245,0.60);
    }
    .soft.error{ color: var(--danger); }

    @media (max-width: 1060px){
      html, body{ overflow:auto; }
      .wrap{
        grid-template-columns: 1fr;
        height: auto;
      }
      .center{ display:none; }
      .float{
        position: sticky;
        left: auto;
        bottom: auto;
        transform: none;
        justify-content: center;
        padding: 14px 0 18px;
      }
    }
  </style>
</head>

<body>
  <div class="bg" aria-hidden="true"></div>

  <div class="header">
    <h1>Adventure Trakker</h1>
  </div>

  <div class="wrap">
    <!-- LEFT: News -->
    <aside class="panel" aria-label="News panel">
      <div class="panel-head">
        <h2 class="panel-title">News</h2>
        <a class="panel-link" href="news.html">Open</a>
      </div>
      <div class="panel-body" id="newsList">
        <div class="soft">Loading…</div>
      </div>
    </aside>

    <!-- CENTER: empty so background map dominates -->
    <main class="center" aria-hidden="true"></main>

    <!-- RIGHT: Upcoming trips -->
    <aside class="panel" aria-label="Upcoming trips panel">
      <div class="panel-head">
        <h2 class="panel-title">Upcoming trips</h2>
        <a class="panel-link" href="trips.html">Open</a>
      </div>
      <div class="panel-body" id="upcomingList">
        <div class="soft">Loading…</div>
      </div>
    </aside>
  </div>

  <div class="float">
    <a class="btn" href="trips.html">View trips</a>
    <a class="btn" href="adder.html">Add trip</a>
  </div>

  <script>
    const sb = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);

    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, (c) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    function fmtDate(ts){
      if (!ts) return "";
      const d = new Date(ts);
      return d.toLocaleDateString(undefined, { year:"numeric", month:"short", day:"numeric" });
    }

    function makeSnippet({ header, body, date }){
      const el = document.createElement("div");
      el.className = "snippet";
      el.innerHTML = `
        <div class="line1">
          <div class="name">${escapeHtml(header)}</div>
          <div class="date">${escapeHtml(date || "")}</div>
        </div>
        <div class="note">${escapeHtml(body || "")}</div>
      `;
      return el;
    }

    async function loadNews(){
      const list = document.getElementById("newsList");
      list.innerHTML = "";

      const { data, error } = await sb
        .from("news")
        .select("id, header, body, created_at")
        .order("created_at", { ascending: false })
        .limit(3);

      if (error){
        const msg = document.createElement("div");
        msg.className = "soft error";
        msg.textContent = "Unable to load news.";
        list.appendChild(msg);
        return;
      }

      const items = data || [];
      if (!items.length){
        const msg = document.createElement("div");
        msg.className = "soft";
        msg.textContent = "No news yet.";
        list.appendChild(msg);
        return;
      }

      for (const n of items){
        list.appendChild(makeSnippet({
          header: n.header,
          body: n.body,
          date: fmtDate(n.created_at)
        }));
      }
    }

    async function loadUpcomingTrips(){
      const list = document.getElementById("upcomingList");
      list.innerHTML = "";

      // Next 3 trips by start date. (If you don’t want this yet, we can swap back to placeholders.)
      const today = new Date();
      const isoToday = today.toISOString().slice(0,10);

      const { data, error } = await sb
        .from("trips")
        .select("id, trip_title, start_date, end_date")
        .gte("start_date", isoToday)
        .order("start_date", { ascending: true })
        .limit(3);

      if (error){
        const msg = document.createElement("div");
        msg.className = "soft error";
        msg.textContent = "Unable to load trips.";
        list.appendChild(msg);
        return;
      }

      const items = data || [];
      if (!items.length){
        const msg = document.createElement("div");
        msg.className = "soft";
        msg.textContent = "No upcoming trips.";
        list.appendChild(msg);
        return;
      }

      for (const t of items){
        list.appendChild(makeSnippet({
          header: t.trip_title || "Untitled",
          body: "",
          date: `${t.start_date || ""} → ${t.end_date || ""}`
        }));
      }
    }

    loadNews();
    loadUpcomingTrips();
  </script>
</body>
</html>
