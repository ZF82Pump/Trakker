<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Adventure Trakker</title>

  <!-- Leaflet (map) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Supabase + config + auth UI -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./supabase-config.js"></script>
  <script src="./auth-ui.js"></script>

  <style>
    :root{
      --header-color: rgba(180, 180, 180, 0.92);
      --glass-bg: rgba(255, 255, 255, 0.18);
      --glass-bg-strong: rgba(255, 255, 255, 0.28);
      --glass-border: rgba(255, 255, 255, 0.22);
      --text-soft: rgba(245, 245, 245, 0.88);
      --text-dim: rgba(245, 245, 245, 0.70);
      --shadow: 0 14px 30px rgba(0,0,0,0.25);
      --danger: rgba(255,120,120,0.92);
    }

    html, body{
      height:100%;
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:#0b0b0b;
      overflow:hidden;
    }

    /* Full-screen map */
    #map{
      position:fixed;
      inset:0;
      z-index:0;
      pointer-events:none; /* static background */
    }

    /* Dim map */
    .map-dimmer{
      position:fixed;
      inset:0;
      z-index:1;
      background: rgba(0,0,0,0.35);
      pointer-events:none;
    }

    /* Vignette */
    .vignette{
      position:fixed;
      inset:-40px;
      z-index:2;
      pointer-events:none;
      background:
        radial-gradient(ellipse at center,
          rgba(0,0,0,0.0) 0%,
          rgba(0,0,0,0.35) 70%,
          rgba(0,0,0,0.55) 100%);
    }

    /* UI overlay */
    .ui{
      position:fixed;
      inset:0;
      z-index:3;
      display:flex;
      flex-direction:column;
      pointer-events:none;
    }

    /* Header */
    .header{
      padding: 34px 18px 0;
      text-align:center;
      user-select:none;
    }
    .header h1{
      margin:0;
      font-weight:300;
      letter-spacing:0.06em;
      color:var(--header-color);
      font-size:clamp(40px,6vw,72px);
      text-shadow:0 10px 26px rgba(0,0,0,0.35);
    }

    /* Right panel */
    .right-panel-wrap{
      position:fixed;
      top:110px;
      right:18px;
      bottom:90px;
      width:min(360px,92vw);
      z-index:4;
      pointer-events:auto;
    }

    .right-panel{
      height:100%;
      background:var(--glass-bg-strong);
      border:1px solid var(--glass-border);
      border-radius:18px;
      backdrop-filter:blur(12px);
      box-shadow:var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }

    .rp-head{
      padding:14px;
      border-bottom:1px solid rgba(255,255,255,0.14);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      user-select:none;
    }
    .rp-head h2{
      margin:0;
      font-size:16px;
      font-weight:300;
      letter-spacing:0.04em;
      color:var(--text-soft);
    }
    .rp-status{
      font-size:12px;
      font-weight:300;
      color: var(--text-dim);
      min-height: 14px;
      text-align:right;
    }
    .rp-status.error{ color: var(--danger); }

    .rp-body{
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:auto;
    }

    .trip-card{
      border-radius:14px;
      background:rgba(0,0,0,0.28);
      border:1px solid rgba(255,255,255,0.12);
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .trip-title{
      font-size:14px;
      font-weight:300;
      color:rgba(255,255,255,0.92);
    }
    .trip-date{
      font-size:12px;
      color:rgba(255,255,255,0.75);
    }
    .trip-mini{
      font-size:12px;
      color:rgba(255,255,255,0.70);
      line-height:1.35;
    }

    .empty{
      border-radius:14px;
      background:rgba(0,0,0,0.18);
      border:1px solid rgba(255,255,255,0.10);
      padding: 12px;
      color: rgba(255,255,255,0.70);
      font-size: 12px;
      font-weight: 300;
    }

    /* Bottom buttons */
    .bottom-actions{
      margin-top:auto;
      padding:0 18px 26px;
      display:flex;
      justify-content:center;
    }

    .action-shell{
      pointer-events:auto;
      display:flex;
      gap:12px;
      padding:12px;
      border-radius:18px;
      background:var(--glass-bg);
      border:1px solid var(--glass-border);
      backdrop-filter:blur(10px);
      box-shadow:var(--shadow);
    }

    button{
      appearance:none;
      border:none;
      border-radius:14px;
      padding:12px 16px;
      font-size:14px;
      cursor:pointer;
      color:rgba(245,245,245,0.95);
      background:rgba(20,20,20,0.55);
      border:1px solid rgba(255,255,255,0.14);
    }

    .primary{
      background:rgba(245,245,245,0.14);
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <div class="map-dimmer"></div>
  <div class="vignette"></div>

  <!-- Right panel -->
  <div class="right-panel-wrap">
    <div class="right-panel">
      <div class="rp-head">
        <h2>Upcoming trips</h2>
        <div class="rp-status" id="rpStatus"></div>
      </div>
      <div class="rp-body" id="upcomingList"></div>
    </div>
  </div>

  <div class="ui">
    <div class="header">
      <h1>Adventure Trakker</h1>
    </div>

    <div class="bottom-actions">
      <div class="action-shell">
        <button id="viewTripsBtn" class="primary">View Trips</button>
        <button id="addTripBtn">Add Trip</button>
      </div>
    </div>
  </div>

  <script>
    // Init auth UI (top-right button + modal)
    AuthUI.init();

    // ---- Background map (static) ----
    const map = L.map('map', {
      zoomControl:false,
      attributionControl:false, // keep it cleaner for a background
      dragging:false,
      scrollWheelZoom:false,
      doubleClickZoom:false,
      boxZoom:false,
      keyboard:false,
      tap:false,
      touchZoom:false
    });

    // OSM tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom:19
    }).addTo(map);

    // Fit roughly to USA/Canada/Mexico
    const northAmericaBounds = L.latLngBounds(
      L.latLng(14, -118),
      L.latLng(58, -52)
    );
    map.fitBounds(northAmericaBounds);

    // ---- Navigation ----
    document.getElementById('addTripBtn').addEventListener('click', () => {
      window.location.href = "./adder.html";
    });
    document.getElementById('viewTripsBtn').addEventListener('click', () => {
      window.location.href = "./trips.html";
    });

    // ---- Supabase upcoming trips (public read is OK) ----
    const sb = window.sb || window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);

    const upcomingList = document.getElementById("upcomingList");
    const rpStatus = document.getElementById("rpStatus");

    function setRpStatus(msg, isError=false){
      rpStatus.textContent = msg || "";
      rpStatus.classList.toggle("error", !!isError);
    }

    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, (c) => ({
        "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#39;"
      }[c]));
    }

    function fmtDate(iso){
      if (!iso) return "";
      const d = new Date(String(iso) + "T00:00:00");
      return d.toLocaleDateString(undefined, { year:"numeric", month:"short", day:"numeric" });
    }

    function renderUpcoming(trips){
      upcomingList.innerHTML = "";
      if (!trips.length){
        upcomingList.innerHTML = '<div class="empty">No upcoming trips.</div>';
        return;
      }

      for (const t of trips){
        const title = t.trip_title || "Untitled";
        const dateLine = `${fmtDate(t.start_date)} → ${fmtDate(t.end_date)}`;
        const mini = (t.new_memory_unlocked || t.adventurers || "").trim();

        const card = document.createElement("div");
        card.className = "trip-card";
        card.innerHTML = `
          <div class="trip-title">${escapeHtml(title)}</div>
          <div class="trip-date">${escapeHtml(dateLine)}</div>
          ${mini ? `<div class="trip-mini">${escapeHtml(mini)}</div>` : ``}
        `;
        upcomingList.appendChild(card);
      }
    }

    async function loadUpcomingTrips(){
      setRpStatus("Loading…", false);

      const today = new Date().toISOString().slice(0,10);

      const { data, error } = await sb
        .from("trips")
        .select("id, trip_title, adventurers, start_date, end_date, new_memory_unlocked")
        .gte("start_date", today)
        .order("start_date", { ascending: true })
        .limit(3);

      if (error){
        setRpStatus("Couldn’t load", true);
        renderUpcoming([]);
        return;
      }

      setRpStatus("", false);
      renderUpcoming(data || []);
    }

    loadUpcomingTrips();
  </script>
</body>
</html>
