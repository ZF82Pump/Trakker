<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Adventure Trakker</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-config.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>

  <style>
    :root{
  --text: rgba(245,245,245,0.92);
  --muted: rgba(180,180,180,0.92);
  --panel: rgba(255,255,255,0.10);
  --panel-2: rgba(255,255,255,0.07);
  --border: rgba(255,255,255,0.16);
  --shadow: 0 14px 30px rgba(0,0,0,0.30);
  --bg: #0b0b0b;
  --danger: rgba(255,120,120,0.92);
  --ok: rgba(150,255,190,0.85);
}
html, body{
  height: 100%;
  margin: 0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
}
a{ color: inherit; }

    body{ overflow: hidden; }

    .bg-map{ position: fixed; inset: 0; pointer-events: none; z-index: 0; }
    .bg-map svg{ width:100%; height:100%; display:block; }
    .bg-vignette{
      position: fixed; inset: 0; pointer-events:none; z-index:1;
      background:
        radial-gradient(ellipse at top, rgba(255,255,255,0.05), rgba(0,0,0,0) 55%),
        radial-gradient(ellipse at center, rgba(0,0,0,0) 50%, rgba(0,0,0,0.55) 100%);
      opacity: 0.95;
    }

    .header, .wrap, .float, .topright{ position: relative; z-index: 2; }

    .header{
      position: absolute; left:0; right:0; top:18px;
      text-align:center; pointer-events:none;
    }
    .header h1{
      margin:0;
      font-weight:300;
      letter-spacing:0.08em;
      color: rgba(190,190,190,0.92);
      font-size: clamp(28px, 3vw, 46px);
      text-shadow: 0 12px 26px rgba(0,0,0,0.40);
    }

    .topright{
      position: fixed;
      top: 18px;
      right: 16px;
      z-index: 10;
    }
    .pill{
      display:inline-flex; align-items:center; gap:10px;
      padding: 10px 12px;
      border-radius: 16px;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.16);
      box-shadow: var(--shadow);
      text-decoration:none;
      font-weight: 300;
      font-size: 13px;
      color: rgba(245,245,245,0.88);
      user-select:none;
    }
    .pill:hover{ background: rgba(255,255,255,0.13); }

    .wrap{
      height: 100%;
      display: grid;
      grid-template-columns: 360px 1fr 360px;
      gap: 14px;
      padding: 18px 16px;
      box-sizing: border-box;
    }

    .panel{
      align-self: start;
      margin-top: 74px;
      border-radius: 18px;
      background: var(--panel);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      overflow: hidden;
      backdrop-filter: blur(6px);
    }
    .panel .panel-head{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.06);
    }
    .panel .panel-title{
      margin:0;
      font-weight:300;
      letter-spacing:0.05em;
      color: rgba(220,220,220,0.85);
      font-size: 14px;
      user-select:none;
    }
    .panel .panel-link{
      text-decoration:none;
      font-size: 12px;
      font-weight: 300;
      color: rgba(245,245,245,0.75);
      padding: 8px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      user-select:none;
    }
    .panel .panel-body{
      padding: 12px 14px 14px;
      display:flex; flex-direction:column; gap:10px;
      background: var(--panel-2);
      min-height: 120px;
    }

    .snippet{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      padding: 10px 12px;
    }
    .snippet .line1{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom: 6px;
    }
    .snippet .name{
      font-size: 13px; font-weight:300;
      color: rgba(245,245,245,0.90);
      white-space: nowrap; overflow:hidden; text-overflow: ellipsis;
      min-width:0; flex:1;
    }
    .snippet .date{
      font-size: 12px; font-weight:300;
      color: rgba(245,245,245,0.65);
      white-space: nowrap;
    }
    .snippet .note{
      font-size: 12px; font-weight:300;
      color: rgba(245,245,245,0.70);
      line-height: 1.35;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow:hidden;
    }

    .center{ margin-top: 74px; }

    .soft{ font-size: 12px; font-weight:300; color: rgba(245,245,245,0.60); }
    .soft.error{ color: var(--danger); }

    .float{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      display:flex;
      gap: 12px;
      z-index: 10;
    }
    .btn{
      border: none;
      border-radius: 16px;
      padding: 12px 16px;
      cursor: pointer;
      color: rgba(245,245,245,0.92);
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(255,255,255,0.16);
      box-shadow: var(--shadow);
      font-weight: 300;
      letter-spacing: 0.02em;
      text-decoration:none;
      user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,0.15); }

    @media (max-width: 1060px){
      body{ overflow:auto; }
      .wrap{ grid-template-columns: 1fr; height:auto; }
      .center{ display:none; }
      .float{
        position: sticky;
        left: auto; bottom: auto;
        transform: none;
        justify-content: center;
        padding: 14px 0 18px;
      }
    }
  </style>
</head>

<body>
  <div class="bg-map" aria-hidden="true"><svg id="worldSvg"></svg></div>
  <div class="bg-vignette" aria-hidden="true"></div>

  <div class="topright">
    <a id="authBtn" class="pill" href="signin.html">Sign in / Sign up</a>
  </div>

  <div class="header">
    <h1>Adventure Trakker</h1>
  </div>

  <div class="wrap">
    <aside class="panel" aria-label="News panel">
      <div class="panel-head">
        <h2 class="panel-title">News</h2>
        <a class="panel-link" href="news.html">Open</a>
      </div>
      <div class="panel-body" id="newsList">
        <div class="soft">Loading…</div>
      </div>
    </aside>

    <main class="center" aria-hidden="true"></main>

    <aside class="panel" aria-label="Upcoming trips panel">
      <div class="panel-head">
        <h2 class="panel-title">Upcoming trips</h2>
        <a class="panel-link" href="trips.html">Open</a>
      </div>
      <div class="panel-body" id="upcomingList">
        <div class="soft">Loading…</div>
      </div>
    </aside>
  </div>

  <div class="float">
    <a class="btn" href="trips.html">View trips</a>
    <a class="btn" href="adder.html">Add trip</a>
  </div>

  <script>
    function esc(s){
  return String(s ?? "").replace(/[&<>"']/g, (c) => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}
function usernameToEmail(username){
  return `${String(username).trim().toLowerCase()}@trakker.site`;
}
function normalizeUsername(username){
  return String(username || "").trim().toLowerCase();
}
function isValidUsername(username){
  // lowercase letters, numbers, underscore, dot. 3-24 chars.
  return /^[a-z0-9._]{3,24}$/.test(username);
}
function hashToHue(str){
  let h = 0;
  for (let i=0;i<str.length;i++){
    h = (h * 31 + str.charCodeAt(i)) >>> 0;
  }
  return h % 360;
}
function initialFromNickname(nickname){
  const n = String(nickname || "").trim();
  if (!n) return "?";
  const ch = n[0].toUpperCase();
  return /[A-Z0-9]/.test(ch) ? ch : "?";
}
function colorFromNickname(nickname){
  const hue = hashToHue(String(nickname||""));
  return `hsl(${hue} 70% 60%)`;
}

    const sb = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);

    function fmtDate(ts){
      if (!ts) return "";
      const d = new Date(ts);
      return d.toLocaleDateString(undefined, { year:"numeric", month:"short", day:"numeric" });
    }
    function makeSnippet(o){
      const el = document.createElement("div");
      el.className = "snippet";
      el.innerHTML = `
        <div class="line1">
          <div class="name">${esc(o.header)}</div>
          <div class="date">${esc(o.date || "")}</div>
        </div>
        <div class="note">${esc(o.body || "")}</div>
      `;
      return el;
    }

    async function loadNews(){
      const list = document.getElementById("newsList");
      list.innerHTML = "";

      const { data, error } = await sb
        .from("news")
        .select("id, header, body, created_at")
        .order("created_at", { ascending: false })
        .limit(3);

      if (error){
        const msg = document.createElement("div");
        msg.className = "soft error";
        msg.textContent = "Unable to load news.";
        list.appendChild(msg);
        return;
      }

      const items = data || [];
      if (!items.length){
        const msg = document.createElement("div");
        msg.className = "soft";
        msg.textContent = "No news yet.";
        list.appendChild(msg);
        return;
      }

      for (const n of items){
        list.appendChild(makeSnippet({
          header: n.header,
          body: n.body,
          date: fmtDate(n.created_at)
        }));
      }
    }

    async function loadUpcomingTrips(){
      const list = document.getElementById("upcomingList");
      list.innerHTML = "";

      const isoToday = new Date().toISOString().slice(0,10);

      const { data, error } = await sb
        .from("trips")
        .select("id, trip_title, start_date, end_date")
        .gte("start_date", isoToday)
        .order("start_date", { ascending: true })
        .limit(3);

      if (error){
        const msg = document.createElement("div");
        msg.className = "soft error";
        msg.textContent = "Unable to load trips.";
        list.appendChild(msg);
        return;
      }

      const items = data || [];
      if (!items.length){
        const msg = document.createElement("div");
        msg.className = "soft";
        msg.textContent = "No upcoming trips.";
        list.appendChild(msg);
        return;
      }

      for (const t of items){
        list.appendChild(makeSnippet({
          header: t.trip_title || "Untitled",
          body: "",
          date: `${t.start_date || ""} → ${t.end_date || ""}`
        }));
      }
    }

    async function renderWorldBackground(){
      const svg = d3.select("#worldSvg");
      const w = window.innerWidth;
      const h = window.innerHeight;

      svg.attr("viewBox", `0 0 ${w} ${h}`).attr("preserveAspectRatio", "xMidYMid slice");
      svg.selectAll("*").remove();

      const fill = "rgba(255,255,255,0.05)";
      const stroke = "rgba(255,255,255,0.15)";
      const stroke2 = "rgba(255,255,255,0.10)";

      const url = "https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json";
      const topo = await fetch(url).then(r => r.json());
      const countries = topojson.feature(topo, topo.objects.countries);

      const projection = d3.geoNaturalEarth1().fitSize([w, h], countries);
      const path = d3.geoPath(projection);

      svg.append("g")
        .selectAll("path")
        .data(countries.features)
        .join("path")
        .attr("d", path)
        .attr("fill", fill)
        .attr("stroke", stroke)
        .attr("stroke-width", 1);

      svg.append("path")
        .datum({type:"Sphere"})
        .attr("d", path)
        .attr("fill", "none")
        .attr("stroke", stroke2)
        .attr("stroke-width", 1);
    }

    async function refreshAuthButton(){
      const btn = document.getElementById("authBtn");
      const { data: { user } } = await sb.auth.getUser();
      if (user){
        btn.textContent = "Profile";
        btn.href = "profile.html";
      } else {
        btn.textContent = "Sign in / Sign up";
        btn.href = "signin.html";
      }
    }

    loadNews();
    loadUpcomingTrips();
    refreshAuthButton();

    let resizeTimer = null;
    function scheduleRender(){
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(renderWorldBackground, 160);
    }
    renderWorldBackground();
    window.addEventListener("resize", scheduleRender);
  </script>
</body>
</html>
